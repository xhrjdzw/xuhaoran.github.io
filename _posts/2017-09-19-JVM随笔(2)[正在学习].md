# 理解JVM 3
## HotSpot 对象创建过程

### 对象创建过程

当虚拟机遇到new的时候，会进行对象的创建工作：
1. 检查常量池中是否有这个类的符号引用：如果没有定义则抛出 ClassNotFoundException，如果有则做下一步操作
2. 检查这个符号引用所代表的类是否已经被JVM加载：如果没有被加载，就去寻找class文件，加载到方法区。如果已经被加载，就分配内存。
3. 根据方法中类的信息确定这个类需要的内存大小：一个对象需要的内存大小实在这个对象所属类被定义的时候就能确定的！一个类所生茶的所有对象的内存大小都是一样的【JVM在加载的类到方法区的时候就知道这个类生产的每一个对象所需要的内存大小】
4. 从堆中划分一块对应大小的内存空间给新的对象：堆分配内存的两种方式1指针碰撞2空闲列表【JVM究竟采用哪种内存分配的方法，取决于它使用了哪种垃圾回收器】
5. 对象中成员变量赋上初始值
6. 设置对象头信息
7. 调用对象的构造函数进行初始化。
 

## 对象的内存模型


一个对象从逻辑的角度看，它的组成由成员变量和成员函数组成，从物理的角度看，对象士在堆中存储的一串二进制数。这个二进制数分为三个部分：
1. 对象头
2. 实例数据
3. 对其补充

### 对象头

对象头中记录了对象在运行的过程中需要的使用的一系列数据：哈希码 GC分带年龄 锁标志 线程持有的锁 偏向时间戳等
此外对象头中还有可能包含类型指针。通过该指针能确定这个对象所属哪个类。此外如果这个对象是一个数组吗，对象头还包含数组长度

### 实例数据

这个部分就是成员变量的值 其中包含父类成员变量和本类成员变量

### 对齐补充

用于确保对象的总长度是8字节的整数倍
HotSpot要求对象的总长度必须是8字节的整数倍，由于对象头一定是8字节的整数倍，但是实例数据的部分的长度是任意的，因此需要对齐补充字段确保这个对象的总长度是8的整数倍。

## 访问对象的过程
引用类型的变量中存放的是一个地址，所以根据地址类型的不同，对象也有不同的访问方式：
1. 句柄的访问方式。 堆中有一块区域叫做“句柄池”的内存空间，用于存放所有对象的地址和所有对象所属类的类信息。
引用类型的变量存放的是该对象在句柄池中的地址，访问对象时，首先需要通过引用类型的变量找到该对象的句柄，然后根据句柄中对象的地址再访问对象。
2. 直接指针访问的方式 引用类型的变量直接存放着对象地址，通过引用能过直接访问对象，但是对象所在的内存空间需要额外的策略存储对象所属类信息的地址。

### 比较

HotSpot采用直接指针的方式访问对象，只需要一次操作，性能是句柄的一倍。但是需要额外的策略存储对象在方法区中类信息的地址。










